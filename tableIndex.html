<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <script src="Scripts/WExpDev.js"></script>
    <link rel="stylesheet" href="Styles/WStyleForm.css" />
    <link rel="stylesheet" href="Styles/WchartStyle.css" />

    <style type="text/css">
      table.dataTable {
          clear: both;
          margin-top: 6px !important;
          margin-bottom: 6px !important;
          max-width: none !important;
          border-collapse: separate !important;
          border-spacing: 0;
      }
      .tableCM {
          border-collapse: separate;
          border: solid 1px #a5a5a5 !important;
          height: 100% !important;
      }
      .GrupFormTable {
          height: 300px;
      }
      .tableCM {
          border-collapse: separate;
          border: solid 1px #a5a5a5 !important;
          height: 100% !important;
      }
    </style>
    <script>
        var Arry = [
              {cantidad: 999, estado: "Fresa", time: 2018, categ: "Severo", categ2:"Psicovitalem"  },
                {cantidad: 99, estado: "Fresa", time: 2018, categ: "Bajo", categ2:"Psicovitalem"  },
                {cantidad: 115, estado: "Naranja", time: 2018, categ: "Bajo", categ2:"Psicovitalem" },
                {cantidad: 118, estado: "Verde", time: 2018, categ: "Bajo", categ2:"Psicovitalem" },


                {cantidad: 116, estado: "Fresa", time: 2019, categ: "Bajo", categ2:"Psicovitalem" },
                {cantidad: 116, estado: "Naranja", time: 2019, categ: "Bajo", categ2:"Psicovitalem" },
                {cantidad: 112, estado: "Verde", time: 2019, categ: "Bajo", categ2:"Psicovitalem" },

                {cantidad: 95, estado: "Fresa", time: 2020, categ: "Bajo", categ2:"Psicovitalem" },
                {cantidad: 97, estado: "Naranja", time: 2020, categ: "Bajo", categ2:"Psicovitalem" },
                {cantidad: 118, estado: "Verde", time: 2020, categ: "Bajo", categ2:"Psicovitalem" },

                {cantidad: 126, estado: "Fresa", time: 2018, categ: "Moderado", categ2:"Psicovitalem" },
                {cantidad: 108, estado: "Naranja", time: 2018, categ: "Moderado", categ2:"Psicovitalem" },
                {cantidad: 111, estado: "Verde", time: 2018, categ: "Moderado", categ2:"Psicovitalem" },

                {cantidad: 117, estado: "Fresa", time: 2019, categ: "Moderado", categ2:"Psicovitalem" },
                {cantidad: 115, estado: "Naranja", time: 2019, categ: "Moderado", categ2:"G2" },
                {cantidad: 102, estado: "Verde", time: 2019, categ: "Moderado", categ2:"G2" },

                {cantidad: 105, estado: "Fresa", time: 2020, categ: "Moderado", categ2:"G2" },
                {cantidad: 107, estado: "Naranja", time: 2020, categ: "Moderado", categ2:"G2" },
                {cantidad: 126, estado: "Verde", time: 2020, categ: "Moderado", categ2:"G2" },

                {cantidad: 109, estado: "Fresa", time: 2018, categ: "Severo", categ2:"G2" },
                {cantidad: 112, estado: "Naranja", time: 2018, categ: "Severo", categ2:"G2" },
                {cantidad: 92, estado: "Verde", time: 2018, categ: "Severo", categ2:"G2" },

                {cantidad: 107, estado: "Fresa", time: 2019, categ: "Severo", categ2:"G2" },
                {cantidad: 104, estado: "Naranja", time: 2019, categ: "Severo", categ2:"G2" },
                {cantidad: 101, estado: "Verde", time: 2019, categ: "Severo", categ2:"G2" },

                {cantidad: 116, estado: "Fresa", time: 2020, categ: "Severo", categ2:"G2" },
                {cantidad: 113, estado: "Naranja", time: 2020, categ: "Severo", categ2:"G2" },
                {cantidad: 113, estado: "Verde", time: 2020, categ: "Severo", categ2:"G2" }                
              ];
        var labels = [
          {time: 2018},
          {time: 2019},
          {time: 2020},
        ]
        var SecondGroupDataset = [
           {categ: "Severo"}, {categ: "Moderado"}, {categ: "Bajo"}
        ]
        var ThreeGroupDataset = [//este es solo para la tabla
           {categ2: "Psicovitalem"}, {categ2: "G2"}
        ]

        // {cantidad: 99, estado: "Fresa", time: 2018, categ: "Bajo", categ2:"Psicovitalem" , categ3:"Bajo"},

        var Totals = [
         {cantidad: 999, categ: "Severo", categ2: "Psicovitalem", time: 2018 },
         {cantidad: 503, categ: "Severo", categ2: "Psicovitalem", time: 2019},
         {cantidad: 403, categ: "Severo", categ2: "Psicovitalem", time: 2020 },
         {cantidad: 503, categ: "Bajo", categ2: "Psicovitalem", time: 2020},
         {cantidad: 587, categ: "Bajo", categ2: "Psicovitalem", time: 2019 },
         {cantidad: 387, categ: "Bajo", categ2: "Psicovitalem", time: 2018 },
         {cantidad: 603, categ: "Moderado", categ2: "Psicovitalem", time: 2020 },
         {cantidad: 287, categ: "Moderado", categ2: "Psicovitalem", time: 2019 },
         {cantidad: 387, categ: "Moderado", categ2: "Psicovitalem", time: 2018 },
         
         {cantidad: 573, categ: "Severo", categ2: "G2", time: 2018},
         {cantidad: 303, categ: "Severo", categ2: "G2", time: 2019},
         {cantidad: 503, categ: "Severo", categ2: "G2", time: 2020},
         {cantidad: 603, categ: "Bajo", categ2: "G2", time: 2020},
         {cantidad: 587, categ: "Bajo", categ2: "G2", time: 2019,},
         {cantidad: 327, categ: "Bajo", categ2: "G2", time: 2018,},
         {cantidad: 623, categ: "Moderado", categ2: "G2", time: 2020},
         {cantidad: 237, categ: "Moderado", categ2: "G2", time: 2019,},
         {cantidad: 387, categ: "Moderado", categ2: "G2", time: 2018}
        ]
        var Estados = ['Fresa', 'Naranja', 'Verde']
        var Estados2 = ['Severo', 'Moderado', 'Bajo']//pasar input del menu, lo q se tiene seleccionado

        var Colors = [ '#ff6699', '#ffbb99', '#adebad']          

            
            var Config = { 
                ContainerName : "MyChart",
                Title : "MyChart2",
                GroupLabelsData: Estados,
                GroupDataset:labels,
                Datasets:Arry,
                Colors:Colors,
                SecondGroupDataset:SecondGroupDataset,
                ThreeGroupDataset:ThreeGroupDataset,
                GroupDataTotals:Totals,
                ContainerSize: 500,
                ColumnLabelDisplay: 2
            }

      
      var SecondGroupDataset = [
            {categ2: "Psicovitalem"}, {categ2: "G2"}
            //{categ: "Severo"}, {categ: "Moderado"}, {categ: "Bajo"}
        ]
        var ThreeGroupDataset = [//este es solo para la tabla
           {categ: "Severo"}, {categ: "Moderado"}, {categ: "Bajo"}
        ]
        var Estados = //este es el input que dibuja el menu izquierdo 
            [{"id_":"Fresa","Descripcion":"Severa"},
            {"id_":"Naranja","Descripcion":"Moderada"},
            {"id_":"Verde","Descripcion":"Sin sintomas"}]
            
      var Config2 = { 
                ContainerName : "MyChart",
                Title : "MyChart3",
                GroupLabelsData: Estados,//series                
                Datasets:Arry,
                AttNameEval : "estado",
                Colors:Colors,
                GroupDataset:labels,
                AttNameG1 : "time",
                SecondGroupDataset:SecondGroupDataset,                
                AttNameG2 : "categ2",
                ThreeGroupDataset:ThreeGroupDataset,
                AttNameG3 : "categ",                
                GroupDataTotals:Totals,
                ContainerSize: 500,
                ColumnLabelDisplay: 2
            }
            window.onload = OnLoad;
            function OnLoad() {
                //DrawThreeGroupChart(Config);
                dibujarTabla3("mitablaUsuariosDadosAlta",Config2)
            }   
    </script>
  </head>
  <body>
    <div id="MyChart">      
    </div>
   <div class="GroupFormDatos w-100" id="ContainerE_AB">      
      <table  border="1|0" id="mitablaUsuariosDadosAlta" class="table table-striped dataTable no-footer w-100" style="width: 100%!important">
      <thead>
      </thead>
        <tbody>
        </tbody>
      </table>      
    </div>
  </body>
  <script type="text/javascript">
    
   
    function dibujarTabla3(tableID, result) {

    var arregloCategoria = result.GroupLabelsData;
    /**********CONSTRUCCION DE TABLA***********/  
    //var ArrayCateg = result.SecondGroupDataset;

    var myThead = GetObj(tableID).querySelector("thead");
    myThead.innerHTML = "";
    var tr = document.createElement("tr");
    var tr2 = document.createElement("tr");
    var tr0 = document.createElement("tr");
  
    var tr3 = document.createElement("tr");
  
    myThead.append(tr3, tr0, tr, tr2);
    var th3 = document.createElement("th");
    th3.innerHTML = "A. Especifico";
  
    var th0 = document.createElement("th");
    th0.innerHTML = "A. Basico";
    var th = document.createElement("th");
    th.innerHTML = "Evoluci√≥n";
    var th2 = document.createElement("th");
    th2.innerHTML = "";
    th2.style = "font-weight:bold !important";
    tr0.append(th0);
    tr.append(th);
    tr2.append(th2);
    tr3.append(th3);
  
    //CONSTRUIR CABECERA
    var ArrayCateg2 = result.SecondGroupDataset;//SEGUNDA AGRUPACION
    var ArrayCateg3 = result.ThreeGroupDataset;//tercera AGRUPACION 
    //console.log(ArrayCateg3)
    for (let index3 = 0; index3 < ArrayCateg3.length; index3++) {
      const ArrayCategElement3 = ArrayCateg3[index3][result.AttNameG3];
      //alert(ArrayCategElement3)
      for (let index = 0; index < ArrayCateg2.length; index++) {
        const ArrayCategElement = ArrayCateg2[index][result.AttNameG2];
        //console.log(ArrayCategElement)
        var colSpan = 0;
        for (let z = 0; z < result.GroupDataset.length; z++) {
          const element = result.GroupDataset[z];
          var th = document.createElement("th");
          th.innerHTML = element[result.AttNameG1];
          th.setAttribute("colspan", "2");
          tr.append(th);
          var th2 = document.createElement("th");
          th2.innerHTML = "total";
          tr2.append(th2);
          var th3 = document.createElement("th");
          th3.innerHTML = "%";
          tr2.append(th3);
          if (z > 0) {
            th.setAttribute("colspan", "3");
            var th2 = document.createElement("th");
            th2.innerHTML = "Incre.";
            tr2.append(th2);
            colSpan = colSpan + 3;
          } else {
            colSpan = colSpan + 2;
          }
        }
  
        var thCateg = document.createElement("th");
        thCateg.setAttribute("colspan", colSpan);
        thCateg.innerHTML = ArrayCategElement;
        tr0.append(thCateg);
      } 
  
      var thCateg3 = document.createElement("th");
        thCateg3.setAttribute("colspan", colSpan*2);
        thCateg3.innerHTML = ArrayCategElement3;
        tr3.append(thCateg3);
    }
  
    //CONSTRUIR BODY    
    var myTbody = GetObj(tableID).querySelector("tbody");
    myTbody.innerHTML = "";
  
    
      for (let z = 0; z < arregloCategoria.length; z++) {
        //console.log(arregloCategoria)
        const element = arregloCategoria[z];
        var trD = document.createElement("tr");
        var td = document.createElement("td");
        td.innerHTML = element.Descripcion;
        td.style = "font-weight:bold !important";
        trD.append(td);
        var pasado = null;
        //console.log(arregloCategoria)
        for (let index3 = 0; index3 < ArrayCateg3.length; index3++) {
          const ArrayCategElement3 = ArrayCateg3[index3][result.AttNameG3];
          
          for (let index = 0; index < ArrayCateg2.length; index++) {
            const ArrayCategElement = ArrayCateg2[index][result.AttNameG2];//ArrayCateg[index].categ;
            
            for (let index = 0; index < result.GroupDataset.length; index++) {
              const elementTime = result.GroupDataset[index];
              //console.log(result)
              var td = document.createElement("td");
              var numero = sumarElement(result.Datasets, elementTime[result.AttNameG1], element.id_, ArrayCategElement,result, ArrayCategElement3);              
              var total = sumarTotal(result.GroupDataTotals, elementTime[result.AttNameG1],ArrayCategElement ,ArrayCategElement3, result);
              td.innerHTML = numero;///****
              trD.append(td);
              var td = document.createElement("td");
              td.innerHTML = Math.round((numero / total) * 100) + "%";
              trD.append(td);
              if (index > 0) {
                var tdIn = document.createElement("td");
                if (pasado == 0) {
                  var divisor = 1;
                } else {
                  divisor = pasado;
                }
                tdIn.innerHTML = Math.round(((numero - pasado) / divisor) * 100) + "%";          
                trD.append(tdIn);
              }
              pasado = Math.round(numero);
            }
          }
        }
        myTbody.append(trD);
      }
  
    //CONSTRUIR FOOTER
    var trT = document.createElement("tr");
    var tdT = document.createElement("td");
    tdT.innerHTML = "Totales";
    tdT.style = "font-weight:bold !important";
    trT.append(tdT);
    myTbody.append(trT);
    pasado = null;
    for (let index = 0; index < ArrayCateg2.length; index++) {
      const ArrayCategElement = ArrayCateg2[index][result.AttNameG2];
      
      for (let index3 = 0; index3 < ArrayCateg3.length; index3++) {//terer grupo
        const ArrayCategElement3 = ArrayCateg3[index3][result.AttNameG3];

        for (let z = 0; z < result.GroupDataset.length; z++) {
          const elementTime = result.GroupDataset[z];
          //console.log(ArrayCategElement)
          var total = sumarTotal(result.Datasets, elementTime[result.AttNameG1], ArrayCategElement,ArrayCategElement3,result);
          var td = document.createElement("td");
          td.innerHTML = Math.round(total);
          trT.append(td);
          var td = document.createElement("td");
          td.innerHTML = "100%";
          trT.append(td);
          if (z > 0) {
            var tdIn = document.createElement("td");
            if (pasado == 0) {
                  var divisor = 1;
                } else {
                  divisor = pasado;
                }

            tdIn.innerHTML = Math.round(((total - pasado) / divisor) * 100) + "%";
            trT.append(tdIn);
          }
          pasado = total;
        }
      }//end tercer grupo
  
    }
  
  }
  
  function sumarElement(list, time,categoria, categ = null, result, categ3 = null) {
            var total = 0;
            for (let index = 0; index < list.length; index++) {

              if ( categ3 != null) {  
                    if (list[index][result.AttNameG1] == time && list[index][result.AttNameG2] == categ && list[index][result.AttNameG3] == categ3  && list[index][result.AttNameEval] == categoria) {                    
                        total = total+ list[index]["cantidad"];
                    }  
                }else if (categ != null) {
                  if (list[index][result.AttNameG1] == time && list[index][result.AttNameG2] == categ  && list[index][result.AttNameEval] == categoria) {
                          total = total+ list[index]["cantidad"];                   
                    }  
                }else{
                  if (list[index][result.AttNameG1] == time && list[index][result.AttNameEval] == categoria) {
                          total = total+ list[index]["cantidad"];                 
                    }
                }            
            }
            return total;
          }
  
  /*function sumarTotal3(list, time, categ, categ3, result) {
              var total = 0;
              for (let index = 0; index < list.length; index++) {
                  if (list[index][result.AttNameG1] == time && list[index][result.AttNameG2] == categ && list[index][result.AttNameG3] == categ3) {
                    total = total+ list[index]["cantidad"];
                    
                  }
              }
            return total;
          }*/


  function sumarTotal(list, time, categ = null, categ3 = null, result) {
              var total = 0;
              for (let index = 0; index < list.length; index++) {
                if ( categ3 != null) {  
                    if (list[index][result.AttNameG1] == time && list[index][result.AttNameG2] == categ && list[index][result.AttNameG3] == categ3) {                    
                        total = total+ list[index]["cantidad"];
                    }  
                }else if (categ != null) {
                  if (list[index][result.AttNameG1] == time && list[index][result.AttNameG2] == categ) {
                          total = total+ list[index]["cantidad"];                   
                    }  
                }else{
                    if (list[index][result.AttNameG1] == time) {
                          total = total+ list[index]["cantidad"];                 
                    }
                }
              }
            return total;
          }         
  
          
  </script>
</html>
